version: 0.2

env:
  variables:
    FUNCTION_NAME: "hello-lambdas"
    AWS_REGION: "us-east-1"
    API_GTW_ID: "7r4dquq6pl"
    ACCOUNT_ID: "846286757852"

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo Installing NPM dependencies...
      - npm install
  pre_build:
    commands:
      - echo Testing...
      - npm run test
      - echo Validating Code Style...
      - npm run lint
      - echo Validating Format...
      - npm run prettier
      - echo Getting Open API definition...
      - echo Adding environment variables to Open API definition...
      - ls -l
      - cat api-docs.json
      - |
        #!/bin/bash
        # Read environment variables
        region=$AWS_REGION
        account_id=$ACCOUNT_ID
        function_name=$FUNCTION_NAME

        # Read the template file
        template_file="api-docs.json"

        # Replace placeholders with environment variables
        sed -i '' -e 's/{{region}}/$AWS_REGION/g' -e 's/{{account_id}}/$ACCOUNT_ID/g' "$template_file"

        echo "OpenAPI definition generated successfully."
      - cat api-docs.json
  # build:
  #   commands:
  #     - echo Building...
  #     - npm run build
  #     - echo Updating Lambda function configuration to AWS...
  #     - aws lambda update-function-configuration --function-name $FUNCTION_NAME --handler src/index-hello-world.handler
  #     - echo Waiting for Lambda function configuration update to complete...
  #     - aws lambda wait function-updated --function-name $FUNCTION_NAME
  # post_build:
  #   commands:
  #     - echo $FUNCTION_NAME
  #     - cd ./$FUNCTION_NAME/dist
  #     - ls -l
  #     - echo Updating Lambda function configuration to AWS...
  #     - aws lambda update-function-code --function-name $FUNCTION_NAME --zip-file fileb://$FUNCTION_NAME.zip --publish --output json
  #     - Deploy Lambda in API Gateway...
  #     - echo Getting Open API definition...
  #     - cat api-docs.json